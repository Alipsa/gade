# Installer Scripts: Update Requirements

## Background

The `installFromMaven` scripts (`src/bin/installer/installFromMaven.sh` and
`installFromMaven.groovy`) allow users to install Gade directly from Maven
Central without building from source. They resolve the Gade POM, download all
dependencies, and set up a runnable directory.

The classpath isolation restructure (commit `f9b0b1f`) changed the runtime
distribution layout from a flat `lib/` directory to organized subdirectories.
The installer scripts and their associated launcher scripts
(`src/main/resources/script/gade.sh` / `gade.cmd`) were not updated and are
currently incompatible with the new layout.

## Current State (Broken)

### What the installers create

```
gade.app/
  lib/
    jfx/        - JavaFX platform JARs
    *.jar       - everything else, flat
  gade.sh
  gade.cmd
  env.sh
```

### What the runtime task creates

```
build/image/gade-{platform}/
  lib/
    app/        - Gade application dependencies
    groovy/     - Groovy + Ivy + data-utils JARs
    runtimes/   - gade-runner-boot.jar + gade-runner-engine.jar
    jfx/        - JavaFX modules (or platform-specific dir for bundled JDK)
    gradle/     - Bundled Gradle distribution
    maven/      - Bundled Maven distribution
  version.properties
  gade.sh / gade.cmd
```

### Specific issues

1. **Flat classpath** - the installer dumps all JARs into `lib/`, defeating
   classpath isolation. Gade's dependencies (log4j, Jackson, etc.) leak into
   user Groovy scripts.
2. **Launcher scripts out of sync** - `src/main/resources/script/gade.sh` uses
   `CLASSPATH="${LIB_DIR}/*"` (flat), while the working `src/bin/cponly/gade.sh`
   uses `lib/app/*:lib/groovy/*`.
3. **No embedded tools** - the installer does not download Gradle or Maven
   distributions, so bundled build tool support is missing.
4. **Hardcoded version** - `gadeVersion=1.0.0-SNAPSHOT` is hardcoded in the
   installer scripts.
5. **Splash screen changes** - the launcher scripts don't reflect the AWT
   splash screen changes.

## Required Changes

### 1. JAR classification in the installer

Replicate the JAR sorting logic from `build.gradle` (lines ~547-602). JARs
resolved from Maven need to be placed into the correct subdirectory:

| Subdirectory   | Contents                                          |
|----------------|---------------------------------------------------|
| `lib/groovy/`  | `groovy-*.jar`, `ivy-*.jar`, `data-utils-*.jar`   |
| `lib/app/`     | All other non-JavaFX, non-runtime JARs             |
| `lib/runtimes/`| `gade-runner-boot.jar`, `gade-runner-engine.jar`   |
| `lib/jfx/`     | `javafx-*.jar` (platform-specific)                 |

The classification rules in `build.gradle` use filename pattern matching:

```groovy
// Groovy jars
if (it.name.startsWith('groovy-') || it.name.startsWith('ivy-')
    || it.name.startsWith('data-utils-')) {
    // -> lib/groovy/
}
// Runtime jars
else if (it.name.startsWith('gade-runner-')) {
    // -> lib/runtimes/
}
// Everything else
else {
    // -> lib/app/
}
```

### 2. Embedded tools download

Download and extract Gradle and Maven distributions, matching the logic in the
`runtime` task's `prepareBundledDistribution` closure:

- **Gradle:** `https://services.gradle.org/distributions/gradle-${version}-bin.zip`
  -> `lib/gradle/gradle-${version}/`
- **Maven:** `https://archive.apache.org/dist/maven/maven-3/${version}/binaries/apache-maven-${version}-bin.zip`
  -> `lib/maven/apache-maven-${version}/`

The versions are defined in `build.gradle`:

```groovy
ext.embeddedGradleVersion = '9.3.1'
ext.embeddedMavenVersion = '3.9.12'
```

Consider reading these from the POM metadata or a published properties file
so the installer doesn't need hardcoded versions.

### 3. Update launcher scripts

Update `src/main/resources/script/gade.sh` and `gade.cmd` to match the
classpath structure used by `src/bin/cponly/gade.sh` and `gade.cmd`:

- Classpath: `lib/app/*:lib/groovy/*` instead of `lib/*`
- Module path: `lib/jfx` (already correct)
- Splash: `-Dsplash.minSeconds=2` (AWT-based splash, not separate process)
- Read `version.properties` for JAR name instead of globbing

### 4. Generate version.properties

The installer should create a `version.properties` file in the install
directory, matching the format generated by the `writeVersionProperties` task:

```properties
version=<resolved version>
jarName=gade-<version>.jar
releaseTag=<version>
```

### 5. Remove hardcoded version

Replace the hardcoded `gadeVersion=1.0.0-SNAPSHOT` with a parameter or
auto-detection from the resolved Maven artifact.

## Approach

The Groovy installer (`installFromMaven.groovy`) is the better candidate
to update first since it can reuse Groovy/Maven APIs for dependency resolution
and has more flexibility for the JAR classification logic.

The shell installer (`installFromMaven.sh`) can be updated afterward or
potentially replaced by the Groovy version if a bootstrap mechanism is
available (e.g. using system Groovy or a small bootstrap JAR).

## Verification

After updating, the installed layout should match the runtime task output
(minus the bundled JDK):

```
gade.app/
  lib/
    app/        - Gade application dependencies
    groovy/     - Groovy + Ivy + data-utils
    runtimes/   - runner JARs
    jfx/        - JavaFX modules
    gradle/     - Gradle distribution
    maven/      - Maven distribution
  version.properties
  gade.sh / gade.cmd
  env.sh
```

The launcher scripts should start Gade successfully with the system JDK and
user Groovy scripts should not see Gade's internal dependencies on their
classpath.
